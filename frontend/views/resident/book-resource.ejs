<!-- Set min date using local timezone -->
<script>
function getTodayString() {
    const now = new Date();
    const offset = now.getTimezoneOffset();
    const localNow = new Date(now.getTime() - offset * 60 * 1000);
    return localNow.toISOString().split('T')[0];
}

document.getElementById('resourceSelect').addEventListener('change', function() {
    if (!this.value) return;

    const resource = JSON.parse(this.options[this.selectedIndex].dataset.resource);

    const today = getTodayString();
    const bookingDate = document.getElementById('bookingDate');
    bookingDate.min = today;
    bookingDate.value = today;

    document.getElementById('dateContainer').style.display = 'block';
    loadAvailableSlots();
});

async function loadAvailableSlots() {
    const resourceId = document.getElementById('resourceSelect').value;
    const date = document.getElementById('bookingDate').value;
    if (!resourceId || !date) return;

    const slotsGrid = document.getElementById('slotsGrid');
    const slotsContainer = document.getElementById('slotsContainer');
    const loadingSlots = document.getElementById('loadingSlots');
    const noSlots = document.getElementById('noSlots');

    slotsContainer.style.display = 'block';
    loadingSlots.style.display = 'block';
    slotsGrid.style.display = 'none';
    noSlots.style.display = 'none';
    document.getElementById('submitContainer').style.display = 'none';
    selectedSlot = null;

    try {
        const response = await fetch(`/api/resources/${resourceId}/available-slots?date=${date}`, {
            headers: { 'Authorization': `Bearer ${getToken()}` }
        });
        const data = await response.json();
        loadingSlots.style.display = 'none';

        if (data.availableSlots && data.availableSlots.length > 0) {
            const today = getTodayString();
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();

            slotsGrid.innerHTML = '';
            slotsGrid.style.display = 'grid';

            data.availableSlots.forEach(slot => {
                let showSlot = true;
                if (date === today) {
                    const [hour, min] = slot.split('-')[0].split(':').map(Number);
                    const slotMinutes = hour * 60 + min;
                    if (slotMinutes <= currentMinutes) showSlot = false;
                }

                if (showSlot) {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'slot-btn';
                    btn.textContent = slot;
                    btn.dataset.slot = slot;
                    btn.addEventListener('click', function() {
                        document.querySelectorAll('.slot-btn').forEach(b => b.classList.remove('selected'));
                        this.classList.add('selected');
                        selectedSlot = slot;
                        document.getElementById('submitContainer').style.display = 'block';
                    });
                    slotsGrid.appendChild(btn);
                }
            });

            if (slotsGrid.children.length === 0) noSlots.style.display = 'block';

        } else {
            noSlots.style.display = 'block';
        }

    } catch (error) {
        console.error(error);
        loadingSlots.style.display = 'none';
        showMessage('Error loading slots', 'danger');
    }
}
</script>
