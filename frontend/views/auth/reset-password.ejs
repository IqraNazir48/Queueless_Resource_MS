<!-- frontend/views/auth/reset-password.ejs -->
<%- include('../partials/header', {title: 'Reset Password', authPage: true}) %>

<div class="auth-container">
    <div class="auth-card">
        <div class="logo">
            <h1><i class="bi bi-calendar-check"></i> QueueLess</h1>
            <p>Smart Resource Booking</p>
        </div>
        
        <h2>Enter Reset Code</h2>
        <p class="text-muted mb-4">Enter the 6-digit code sent to your email</p>
        
        <div id="message"></div>
        
        <form id="resetPasswordForm" autocomplete="off">
            <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" name="email" class="form-control" placeholder="Your email" required readonly>
            </div>
            
            <div class="form-group">
                <label for="resetCode">Reset Code</label>
                <input type="text" id="resetCode" name="resetCode" class="form-control" placeholder="Enter 6-digit code" required maxlength="6" pattern="\d{6}" autocomplete="off">
            </div>
            
            <div class="form-group">
                <label for="newPassword">New Password</label>
                <div class="password-container">
                    <input type="password" id="newPassword" name="newPassword" class="form-control" placeholder="Enter new password (min 6 characters)" minlength="6" required autocomplete="new-password">
                    <button type="button" class="password-toggle" onclick="togglePassword()">
                        <i class="bi bi-eye-fill" id="passwordIcon"></i>
                    </button>
                </div>
            </div>
            
            <button type="submit" class="btn-auth" id="submitBtn">
                <span id="btnText">Reset Password</span>
                <span id="spinner" class="spinner-border spinner-border-sm d-none"></span>
            </button>
        </form>
        
        <div class="auth-footer">
            <a href="/forgot-password">Resend Code</a> | <a href="/login">Back to Login</a>
        </div>
    </div>
</div>

<script>
// Load email from session storage
window.addEventListener('DOMContentLoaded', function() {
    const email = sessionStorage.getItem('resetEmail');
    if (email) {
        document.getElementById('email').value = email;
    } else {
        window.location.href = '/forgot-password';
    }
});

function togglePassword() {
    const passwordInput = document.getElementById('newPassword');
    const icon = document.getElementById('passwordIcon');
    
    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        icon.classList.remove('bi-eye-fill');
        icon.classList.add('bi-eye-slash-fill');
    } else {
        passwordInput.type = 'password';
        icon.classList.remove('bi-eye-slash-fill');
        icon.classList.add('bi-eye-fill');
    }
}

document.getElementById('resetPasswordForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const btn = document.getElementById('submitBtn');
    const btnText = document.getElementById('btnText');
    const spinner = document.getElementById('spinner');
    const messageDiv = document.getElementById('message');
    
    const email = document.getElementById('email').value;
    const resetCode = document.getElementById('resetCode').value;
    const newPassword = document.getElementById('newPassword').value;
    
    btn.disabled = true;
    btnText.classList.add('d-none');
    spinner.classList.remove('d-none');
    messageDiv.innerHTML = '';
    
    try {
        const response = await fetch('/api/auth/reset-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ email, resetCode, newPassword })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            messageDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="bi bi-check-circle-fill"></i> ${data.message}
                </div>
            `;
            
            // Clear session storage
            sessionStorage.removeItem('resetEmail');
            
            // Redirect to login after 2 seconds
            setTimeout(() => {
                window.location.href = '/login';
            }, 2000);
        } else {
            messageDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-circle-fill"></i> ${data.message || 'Failed to reset password.'}
                </div>
            `;
            btn.disabled = false;
            btnText.classList.remove('d-none');
            spinner.classList.add('d-none');
        }
        
    } catch (error) {
        console.error('Error:', error);
        messageDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-wifi-off"></i> Network error. Please try again.
            </div>
        `;
        btn.disabled = false;
        btnText.classList.remove('d-none');
        spinner.classList.add('d-none');
    }
});
</script>

<%- include('../partials/footer') %>