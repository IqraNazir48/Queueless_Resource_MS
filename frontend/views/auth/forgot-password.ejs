<!-- frontend/views/auth/forgot-password.ejs -->
<%- include('../partials/header', {title: 'Forgot Password', authPage: true}) %>

<div class="auth-container">
    <div class="auth-card">
        <div class="logo">
            <h1><i class="bi bi-calendar-check"></i> QueueLess</h1>
            <p>Smart Resource Booking</p>
        </div>
        
        <h2>Reset Password</h2>
        <p class="text-muted mb-4">Enter your email to receive a reset code</p>
        
        <div id="message"></div>
        
        <form id="forgotPasswordForm">
            <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" name="email" class="form-control" placeholder="Enter your registered email" required autocomplete="email">
            </div>
            
            <button type="submit" class="btn-auth" id="submitBtn">
                <span id="btnText">Send Reset Code</span>
                <span id="spinner" class="spinner-border spinner-border-sm d-none"></span>
            </button>
        </form>
        
        <div class="auth-footer">
            Remember your password? <a href="/login">Sign in</a>
        </div>
    </div>
</div>

<script>
document.getElementById('forgotPasswordForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const btn = document.getElementById('submitBtn');
    const btnText = document.getElementById('btnText');
    const spinner = document.getElementById('spinner');
    const messageDiv = document.getElementById('message');
    
    const email = document.getElementById('email').value;
    
    btn.disabled = true;
    btnText.classList.add('d-none');
    spinner.classList.remove('d-none');
    messageDiv.innerHTML = '';
    
    try {
        const response = await fetch('/api/auth/request-reset', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ email })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            messageDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="bi bi-check-circle-fill"></i> Reset code sent! Check your email.
                    ${data.resetCode ? `<br><strong>Your reset code is: ${data.resetCode}</strong> (Development Mode)` : ''}
                </div>
            `;
            
            // Store email for reset page
            sessionStorage.setItem('resetEmail', email);
            
            // Redirect to reset page after 2 seconds
            setTimeout(() => {
                window.location.href = '/reset-password';
            }, 2000);
        } else {
            messageDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-circle-fill"></i> ${data.message || 'Failed to send reset code.'}
                </div>
            `;
            btn.disabled = false;
            btnText.classList.remove('d-none');
            spinner.classList.add('d-none');
        }
        
    } catch (error) {
        console.error('Error:', error);
        messageDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-wifi-off"></i> Network error. Please try again.
            </div>
        `;
        btn.disabled = false;
        btnText.classList.remove('d-none');
        spinner.classList.add('d-none');
    }
});
</script>

<%- include('../partials/footer') %>