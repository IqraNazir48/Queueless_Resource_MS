<%- include('../partials/header', {title: 'Register', authPage: true}) %>

<div class="auth-container">
    <div class="auth-card">
        <div class="logo">
            <h1><i class="bi bi-calendar-check"></i> QueueLess</h1>
            <p>Smart Resource Booking</p>
        </div>
        
        <h2>Create Account</h2>
        
        <div id="registerMessage"></div>
        
        <form id="registerForm" autocomplete="on">
            
            <div class="form-group">
                <label for="reg-name">Full Name</label>
                <input 
                    type="text" 
                    id="reg-name" 
                    name="name" 
                    class="form-control" 
                    placeholder="John Doe" 
                    required 
                    autocomplete="name">
            </div>
            
            <div class="form-group">
                <label for="reg-email">Email Address</label>
                <input 
                    type="email" 
                    id="reg-email" 
                    name="username"
                    class="form-control" 
                    placeholder="john.doe@gmail.com" 
                    required 
                    autocomplete="username">
            </div>
            
            <div class="form-group">
                <label for="reg-password">Password</label>
                <div class="password-container">
                    <input 
                        type="password" 
                        id="reg-password" 
                        name="new-password" 
                        class="form-control" 
                        placeholder="Minimum 6 characters" 
                        minlength="6" 
                        required 
                        autocomplete="new-password">
                    <button type="button" class="password-toggle" onclick="togglePassword()" tabindex="-1">
                        <i class="bi bi-eye-fill" id="passwordIcon"></i>
                    </button>
                </div>
            </div>
            
            <div class="form-group">
                <label for="role">Account Type</label>
                <select id="role" name="role" class="form-select" autocomplete="off">
                    <option value="resident">Resident</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            
            <div class="form-group" id="adminCodeGroup" style="display: none;">
                <label for="adminCode">
                    Admin Secret Code <span class="text-danger">*</span>
                </label>
                <input 
                    type="password" 
                    id="adminCode" 
                    name="adminCode" 
                    class="form-control" 
                    placeholder="Enter admin authorization code" 
                    autocomplete="off">
            </div>
            
            <button type="submit" class="btn-auth" id="registerBtn">
                <span id="registerBtnText">Create Account</span>
                <span id="registerSpinner" class="spinner-border spinner-border-sm d-none"></span>
            </button>
        </form>
        
        <div class="auth-footer">
            Already have an account? <a href="/login">Sign in</a>
        </div>
    </div>
</div>

<script>
function togglePassword() {
    const passwordInput = document.getElementById('reg-password');
    const icon = document.getElementById('passwordIcon');
    
    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        icon.classList.remove('bi-eye-fill');
        icon.classList.add('bi-eye-slash-fill');
    } else {
        passwordInput.type = 'password';
        icon.classList.remove('bi-eye-slash-fill');
        icon.classList.add('bi-eye-fill');
    }
}

document.getElementById('role').addEventListener('change', function() {
    const adminCodeGroup = document.getElementById('adminCodeGroup');
    const adminCodeInput = document.getElementById('adminCode');
    
    if (this.value === 'admin') {
        adminCodeGroup.style.display = 'block';
        adminCodeInput.required = true;
    } else {
        adminCodeGroup.style.display = 'none';
        adminCodeInput.required = false;
        adminCodeInput.value = '';
    }
});

document.getElementById('reg-email').addEventListener('blur', function() {
    const email = this.value.toLowerCase();
    const messageDiv = document.getElementById('registerMessage');
    
    if (!email) return;
    
    const domain = email.split('@')[1];
    
    if (!domain) return;
    
    const isValid = domain === 'gmail.com';
    
    if (!isValid) {
        messageDiv.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle-fill"></i> Only Gmail addresses are allowed
            </div>
        `;
    } else {
        messageDiv.innerHTML = '';
    }
});

document.getElementById('registerForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const form = this;
    const btn = document.getElementById('registerBtn');
    const btnText = document.getElementById('registerBtnText');
    const spinner = document.getElementById('registerSpinner');
    const messageDiv = document.getElementById('registerMessage');
    
    const name = document.getElementById('reg-name').value.trim();
    const email = document.getElementById('reg-email').value.trim();
    const password = document.getElementById('reg-password').value;
    const role = document.getElementById('role').value;
    const adminCode = document.getElementById('adminCode').value;
    
    if (role === 'admin' && !adminCode) {
        messageDiv.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle-fill"></i> Admin code required
            </div>
        `;
        return;
    }
    
    btn.disabled = true;
    btnText.classList.add('d-none');
    spinner.classList.remove('d-none');
    messageDiv.innerHTML = '';
    
    try {
        const response = await fetch('/api/auth/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, email, password, role, adminCode })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            localStorage.setItem('token', data.token);
            localStorage.setItem('user', JSON.stringify(data.user));
            
            await fetch('/api/auth/set-cookie', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ token: data.token, user: data.user })
            });
            
            messageDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="bi bi-check-circle-fill"></i> Success! Redirecting...
                </div>
            `;
            
            const redirectUrl = data.user.role === 'admin' ? '/admin/dashboard' : '/dashboard';
            
            setTimeout(() => {
                window.location.href = redirectUrl;
            }, 1500);
            
        } else {
            messageDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-circle-fill"></i> ${data.message}
                </div>
            `;
            btn.disabled = false;
            btnText.classList.remove('d-none');
            spinner.classList.add('d-none');
        }
        
    } catch (error) {
        console.error('Error:', error);
        messageDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-wifi-off"></i> Network error
            </div>
        `;
        btn.disabled = false;
        btnText.classList.remove('d-none');
        spinner.classList.add('d-none');
    }
});
</script>

<%- include('../partials/footer') %>